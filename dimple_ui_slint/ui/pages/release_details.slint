import { HorizontalBox , VerticalBox} from "std-widgets.slint";
import { CardAdapter } from "../components/card.slint";
import { StyleMetrics , ScrollView, ListView, StandardTableView} from "std-widgets.slint";
import { CardGrid } from "../components/card_grid.slint";
import { LinkAdapter, Links, Link} from "../components/link.slint";
import { HorizontalBox , VerticalBox} from "std-widgets.slint";
import { StyleMetrics , ScrollView, ListView, StandardTableView} from "std-widgets.slint";
import { CardAdapter } from "../components/card.slint";
import { CardGrid } from "../components/card_grid.slint";
import { LinkAdapter, Links, Link} from "../components/link.slint";
import { Styles, Navigator, AppState } from "../common.slint";
import { ActionButtons, ActionButton } from "../components/action_buttons.slint";
import { PopupMenu, PopupMenuButton } from "../components/popup_menu.slint";

export global ReleaseDetailsAdapter {
    in property <string> key;
    in property <string> release-type: "Album";
    in property <CardAdapter> card: {
                image: {image: @image-url("../../icons/phosphor/PNGs/regular/vinyl-record.png")},
                title: {name: "A Reign of Fish"},
            };
    in property <string> disambiguation: "Not to be confused with Rain of Fish by Fargo.";
    in property <string> summary: "Fresh Pliers does it again with 'A Reign of Fish'. Magna est quis laboris veniam do laborum. Cupidatat ea ipsum aliquip fugiat eu magna labore est eu est labore. Ex nostrud culpa id veniam aliqua aliqua ipsum. Velit do id amet labore mollit id cillum commodo Lorem proident labore eu. Incididunt minim irure culpa excepteur officia sit consequat est mollit. Ipsum anim anim sunt dolore. Laborum consequat deserunt laboris ullamco cillum. Ullamco deserunt ut quis dolore aliquip esse consequat velit amet. Nulla tempor veniam dolor amet occaecat adipisicing nulla laboris.\n\nQui non irure anim irure nisi nulla ex aliquip. Sit do irure esse magna sit do eiusmod. Anim commodo velit non enim nulla.\n\nAnim incididunt dolore nulla laboris eu mollit Lorem minim reprehenderit in quis magna mollit. Labore Lorem esse anim ipsum esse irure ipsum proident deserunt officia consequat sunt sit. Ex laborum ipsum laboris nisi proident. Nulla culpa est commodo dolor. Magna sint id et ut esse mollit qui elit voluptate ea.\n\nDuis amet qui reprehenderit cupidatat qui proident pariatur non ea aute reprehenderit nisi qui. Et elit anim culpa amet eu excepteur voluptate ad adipisicing esse eiusmod. Aliqua Lorem excepteur fugiat aute ullamco ea nostrud ipsum mollit cupidatat id magna. Nisi consectetur cillum incididunt deserunt non officia non laborum non ullamco non eiusmod dolor. Eu sit aute adipisicing Lorem consectetur nisi excepteur laboris eiusmod exercitation proident eu laborum fugiat. Ad id velit minim laboris eu. Do ex aliqua nisi aliqua laborum sunt qui quis officia labore do. Deserunt culpa culpa Lorem reprehenderit consequat ad pariatur anim quis. Nulla officia id ipsum adipisicing commodo labore culpa consectetur nostrud labore. Reprehenderit minim magna qui ullamco aute incididunt. Ipsum eu ad ex consequat et amet.";
    in property <[LinkAdapter]> genres: [{name: "heavy metal"},{name: "hard rock"},{name: "acid rock"},];
    in property <[LinkAdapter]> links: [{name: "https://bandcamp.com/arof",url: "internal://release/1234"}];
    in property <[LinkAdapter]> artists: [{name: "Fresh Pliers"},{name: "Example Band"},{name: "Teal Cup"},];
    in property <string> dump;
    in property <bool> save;
    in property <bool> love;
    in property <bool> download;
    in property <[[StandardListViewItem]]> row_data: [
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
        [ { text: "hi" }, { text: "hi" }, { text: "hi" }, { text: "hi" } ],
    ];
    in property <[string]> row_keys;

    pure callback sort_table(int /* column */, bool /* ascending */);
    pure callback add_to_queue(string);
    pure callback set_save(bool);
    pure callback set_download(bool);
    pure callback set_love(bool);

    pure callback play_now(string /* key */);
    pure callback play_next(string /* key */);
    pure callback play_later(string /* key */);
}

export component BorderImage inherits Rectangle {
    in-out property <image> image;

    border-radius: Styles.thumbnail-border-radius;
    border-color: Styles.thumbnail-border-color;
    border-width: Styles.thumbnail-border-width;
    clip: true;
    Image {
        width: parent.width;
        height: parent.height;
        source: image;
    }
}

export component ReleaseDetails inherits ScrollView {
    in-out property <length> popup-x;
    in-out property <length> popup-y;
    in-out property <int> popup-row;

    popup := PopupMenu {
        x: popup-x; 
        y: popup-y; 

        PopupMenuButton {
            text: "Play Later";
            icon: @image-url("../../icons/phosphor/SVGs/regular/list-plus.svg");
            clicked => { ReleaseDetailsAdapter.play_later(ReleaseDetailsAdapter.row_keys[popup-row]); }
        }
        PopupMenuButton {
            text: "Play Next";
            icon: @image-url("../../icons/phosphor/SVGs/regular/queue.svg");
            clicked => { ReleaseDetailsAdapter.play_next(ReleaseDetailsAdapter.row_keys[popup-row]); }
        }
        PopupMenuButton {
            text: "Play Now";
            icon: @image-url("../../icons/phosphor/SVGs/regular/play.svg");
            clicked => { ReleaseDetailsAdapter.play_now(ReleaseDetailsAdapter.row_keys[popup-row]); }
        }
        PopupMenuButton {
            text: "Track Info";
            icon: @image-url("../../icons/phosphor/SVGs/regular/info.svg");
            clicked => { Navigator.navigate("dimple://track/" + ReleaseDetailsAdapter.row_keys[root.popup-row]); }
        }
    }    

    VerticalLayout {
        alignment: start;
        // Header: Image, Title, Artists, Genres, Summary
        HorizontalLayout {
            alignment: start;
            VerticalLayout {
                BorderImage {
                    width: Styles.thumbnail-width-extra-large;
                    height: Styles.thumbnail-width-extra-large;
                    image: ReleaseDetailsAdapter.card.image.image;
                }
                ActionButtons {
                    ActionButton {
                        icon: @image-url("../../icons/phosphor/SVGs/regular/play.svg");
                        label: @tr("Play Now");
                        clicked => { ReleaseDetailsAdapter.play_now(ReleaseDetailsAdapter.key); }
                    }
                    ActionButton {
                        icon: @image-url("../../icons/phosphor/SVGs/regular/plus.svg");
                        label: @tr("Play Later");
                        clicked => { ReleaseDetailsAdapter.add_to_queue(ReleaseDetailsAdapter.key); }
                    }
                    ActionButton {
                        icon: self.checked 
                            ? @image-url("../../icons/phosphor/SVGs/fill/heart-fill.svg") 
                            : @image-url("../../icons/phosphor/SVGs/regular/heart.svg");
                        label: @tr("Love");
                        checkable: true;
                        checked: ReleaseDetailsAdapter.love;
                        clicked => { ReleaseDetailsAdapter.set_love(self.checked); }
                    }
                    ActionButton {
                        icon: self.checked 
                            ? @image-url("../../icons/phosphor/SVGs/fill/download-fill.svg") 
                            : @image-url("../../icons/phosphor/SVGs/regular/download.svg");
                        label: @tr("Play Later");
                        checkable: true;
                        checked: ReleaseDetailsAdapter.download;
                        clicked => { ReleaseDetailsAdapter.set_download(self.checked); }
                    }
                }
                Rectangle {
                    vertical-stretch: 1;
                }
            }
            VerticalBox {
                alignment: start;
                // Title
                Text {
                    text: ReleaseDetailsAdapter.card.title.name;
                    font-weight: Styles.font-weight-bold;
                    font-size: 1rem * Styles.page_title_font_rem;
                    wrap: word-wrap;
                }
                // Type and artists
                if ReleaseDetailsAdapter.artists.length > 0: HorizontalLayout {
                    alignment: start;
                    Text {
                        text: "\{ReleaseDetailsAdapter.release-type} by ";
                        font-size: 1.3rem;
                    }
                    Links {
                        links: ReleaseDetailsAdapter.artists;
                        font-size: 1.3rem;
                    }
                }
                // Disambiguation
                if ReleaseDetailsAdapter.disambiguation != "": Text {
                    text: ReleaseDetailsAdapter.disambiguation;
                    font-italic: true;
                    font-size: 1.3rem;
                }
                // Genres
                if ReleaseDetailsAdapter.genres.length > 0: HorizontalLayout {
                    alignment: start;
                    Text {
                        text: "In ";
                        font-size: 1.3rem;
                    }    
                    Links {
                        links: ReleaseDetailsAdapter.genres;
                        font-size: 1.3rem;
                    }
                }
                // Summary
                if ReleaseDetailsAdapter.summary != "": Text {
                    text: ReleaseDetailsAdapter.summary;
                    wrap: word-wrap;
                    font-size: 1.2rem;
                }
            }
        }

        table := StandardTableView {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            columns: [
                { title: "#", horizontal_stretch: 0.10 },
                { title: "Title", horizontal_stretch: 0.50 },
                { title: "Artist", horizontal_stretch: 0.30 },
                { title: "Length", horizontal_stretch: 0.10 },
                ];
            rows: ReleaseDetailsAdapter.row_data;
            sort-ascending(index) => { ReleaseDetailsAdapter.sort_table(index, true); }
            sort-descending(index) => { ReleaseDetailsAdapter.sort_table(index, false); }
            row-pointer-event(row, event, point) => {
                if event.button == PointerEventButton.right 
                        && event.kind == PointerEventKind.down {
                    popup-x = point.x;
                    popup-y = point.y;
                    popup-row = row;
                    popup.show();
                }
                else if event.button == PointerEventButton.left 
                        && row == table.current-row
                        && event.kind == PointerEventKind.down {
                    Navigator.navigate("dimple://track/" + ReleaseDetailsAdapter.row_keys[row]);
                }
            }
        }
        Text {
            horizontal-alignment: right;
            text: ReleaseDetailsAdapter.row_data.length + " items";
        }

        // Links
        if ReleaseDetailsAdapter.links.length > 0: VerticalBox {
            Text {
                text: "Links";
                font-weight: Styles.font-weight-bold;
                font-size: 2rem;
            }
            for link in ReleaseDetailsAdapter.links: Link {
                url: link.url;
                name: link.name;
                font-size: 1.3rem;
            }
        }

        // Debug Dump
        if AppState.debug: VerticalBox {
            Text {
                text: "Debug";
                font-weight: Styles.font-weight-bold;
                font-size: 2rem;
            }
            Text {
                text: ReleaseDetailsAdapter.dump;
                wrap: word-wrap;
                font-size: 1.3rem;
            }
        }
    }
}
