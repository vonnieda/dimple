import { Slider , GroupBox, HorizontalBox} from "std-widgets.slint";
import { StyleMetrics, Button, VerticalBox } from "std-widgets.slint";
import { CardAdapter } from "components/card.slint";
import {Link, LinkAdapter} from "./components/link.slint";
import { Palette, Navigator, AppState } from "common.slint";

export enum PlayerState {
    Playing,
    Paused,
    Stopped,
}

export struct PlayerBarAdapter {
    now_playing_artist: CardAdapter,
    now_playing_release: CardAdapter,
    // TODO track, not recording
    now_playing_recording: CardAdapter,
    up_next_artist: CardAdapter,
    up_next_release: CardAdapter,
    up_next_recording: CardAdapter,
    position_seconds: int,
    duration_seconds: int,
    position_label: string,
    duration_label: string,
    player_state: PlayerState,
}

component InfoAreaLabel inherits HorizontalLayout {
    in property <image> icon;
    in property <float> font-weight;
    in property <LinkAdapter> link;

    Image {
        source: icon;
        height: 1.5rem;
        width: 1.5rem;
        colorize: StyleMetrics.default-text-color;
    }
    Rectangle {
        width: 8px;
    }
    Link {
        url: link.url;
        name: link.name;
        vertical-alignment: bottom;
        font-size: 1.5rem;
        font-weight: font-weight;
    }
}

component PlayerButtons inherits HorizontalLayout {
    in property <bool> playing: false;
    TouchArea {
        width: 46px;
        height: 46px;
        clicked => { AppState.player_previous(); }
        Image {
            source: @image-url("../icons/phosphor/SVGs/fill/skip-back-circle-fill.svg");
            width: 46px;
            height: 46px;
            colorize: parent.has-hover 
                ? Palette.link-color-hover
                : StyleMetrics.default-text-color;
        }                
    }
    TouchArea {
        width: 46px;
        height: 46px;
        clicked => { AppState.player_play_pause(); }
        if playing: Image {
            source: @image-url("../icons/phosphor/SVGs/fill/pause-circle-fill.svg");
            width: 46px;
            height: 46px;
            colorize: parent.has-hover ? Palette.link-color-hover
                : StyleMetrics.default-text-color;
        }                
        if !playing: Image {
            source: @image-url("../icons/phosphor/SVGs/fill/play-circle-fill.svg");
            width: 46px;
            height: 46px;
            colorize: parent.has-hover 
                ? Palette.link-color-hover
                : StyleMetrics.default-text-color;
        }                
    }
    TouchArea {
        width: 46px;
        height: 46px;
        clicked => { AppState.player_next(); }
        Image {
            source: @image-url("../icons/phosphor/SVGs/fill/skip-forward-circle-fill.svg");
            width: 46px;
            height: 46px;
            colorize: parent.has-hover 
                ? Palette.link-color-hover
                : StyleMetrics.default-text-color;
        }                
    }                        
}

component Scrubber inherits VerticalLayout {
    in property <int> position-seconds: 30;
    in property <int> duration-seconds: 120;
    in property <string> position-label: "00:30";
    in property <string> duration-label: "02:00";
    
    Slider { 
        // Once the user drags the slider this binding gets broken
        // and stops updating. See:
        // https://github.com/slint-ui/slint/issues/5990
        // It may be possible to fix by adding a two way binding at
        // the root of this component ala:
        // in-out property <float> position-seconds
        // and binding to that instead.

        value: position-seconds;
        maximum: duration-seconds;
        vertical-stretch: 0;
        changed => { AppState.player_seek(self.value) }
    }
    HorizontalLayout {
        Text {
            text: position-label;
            font-size: 1rem;
        }
        Text {
            horizontal-alignment: right;
            text: duration-label;
            font-size: 1rem;
        }
    }
}

component TrackInfo inherits VerticalLayout {
    in property <LinkAdapter> artist;
    in property <LinkAdapter> release;
    in property <LinkAdapter> recording;
    spacing: 4px;
    InfoAreaLabel {
        icon: @image-url("../icons/phosphor/SVGs/regular/music-notes.svg");
        link: recording;
    }
    InfoAreaLabel {
        icon: @image-url("../icons/phosphor/SVGs/regular/users-three.svg");
        link: artist;
    }
    InfoAreaLabel {
        icon: @image-url("../icons/phosphor/SVGs/regular/vinyl-record.svg");
        link: release;
    }
}

export component PlayerBar {
    in-out property <PlayerBarAdapter> model;

    HorizontalLayout {
        Rectangle {
            width: img.width;
            height: img.height;
            border-radius: Palette.thumbnail-border-radius;
            border-width: Palette.thumbnail-border-width;
            border-color: Palette.thumbnail-border-color;
            clip: true;
            // TODO needs imagelink
            img := Image {
                source: model.now-playing-recording.image.image;
                width: Palette.thumbnail-width-medium;
                height: Palette.thumbnail-width-medium;
            }    
        }
        VerticalLayout {
            padding-left: 8px;
            HorizontalLayout {
                TrackInfo {
                    horizontal-stretch: 0;
                    artist: model.now-playing-artist.title;
                    release: model.now-playing-release.title;
                    recording: model.now-playing-recording.title;
                }
                Rectangle {
                    horizontal-stretch: 1;
                }
                PlayerButtons {
                    playing: model.player-state == PlayerState.Playing;
                }
            }
            Rectangle {
                vertical-stretch: 1;
            }
            Scrubber {
                position-seconds: model.position-seconds;
                position-label: model.position-label;
                duration-seconds: model.duration-seconds;
                duration-label: model.duration-label;
            }
        }
    }
}
